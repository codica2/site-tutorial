"use strict";var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var SiteTutorial=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.config=e,this.blocks=this.sortBlocks(),this.body=document.body,this.html=document.documentElement,this.padding=e.padding>15?15:e.padding?Math.max(0,e.padding):10,this.offset=10,this.time=e.time||1e3,this.frame_rate=.06,this.animate,this.commonStep=-1,this.checkFinish=-1,this.isStarted=!1,this.isHidePopup=!1,this.isShowPopup=!1,this.startPositionScroll=this.blocks[0].offsetTop-window.innerHeight/2,e.popup||this.body.appendChild(this.buildDefaultPopup()),this.popup=document.querySelector("#site-tutorial-control-panel"),this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","site-tutroial"),this.ctx=this.canvas.getContext("2d"),this.commonHeightDocument=this.getCommonHeightdocument(),this.defaultzIndexes=[],this.handleNext=this.next.bind(this),this.handlePrev=this.prev.bind(this),this.handleKeydownArrowRight=this.keydownArrowRight.bind(this),this.handleKeydownArrowLeft=this.keydownArrowLeft.bind(this),this.handleMouseMovePopup=this.mouseMovePopup.bind(this),this.handleMoseLeavePopup=this.mouseLeavePopup.bind(this),this.handleOutclick=this.outclick.bind(this),this.handleStop=this.stop.bind(this),this.initialize(e)}return _createClass(t,[{key:"initialize",value:function(t){var e=this.canvas,i=this.popup,s=this.body;e.width=window.innerWidth,e.height=this.commonHeightDocument,e.style.position="absolute",e.style.zIndex=t.zIndex?t.zIndex:1e3,e.style.top="0px",e.style.left="0px",e.style.display="none",s.appendChild(e),i.style.position="absolute",i.style.visibility="hidden",this.defaultPopLeft=-this.popup.offsetWidth+"px",i.style.left=this.defaultPopLeft,i.style.zIndex=this.canvas.style.zIndex+1,this.buttonPrev=document.querySelector("#prev-site-tutorial"),this.buttonStart=document.querySelector("#start-site-tutorial"),this.buttonNext=document.querySelector("#next-site-tutorial"),this.buttonStop=document.querySelector("#stop-site-tutorial"),this.defaultButtonNextText=this.next.innerHTML,this.stepDescription=0,t.progressBar&&(this.stepProgressBar=0,this.buildProgressBar()),this.getzIndex(),this.config.autoStart&&this.start().bind(this),this.buttonStart.addEventListener("click",this.start.bind(this))}},{key:"addEventListeners",value:function(){this.buttonNext.addEventListener("click",this.handleNext),document.addEventListener("keydown",this.handleKeydownArrowRight),this.buttonPrev.addEventListener("click",this.handlePrev),this.body.addEventListener("keydown",this.handleKeydownArrowLeft),this.popup.addEventListener("mousemove",this.handleMouseMovePopup),this.popup.addEventListener("mouseleave",this.handleMoseLeavePopup),this.buttonStop.addEventListener("click",this.handleStop),document.addEventListener("click",this.handleOutclick)}},{key:"removeEventListeners",value:function(){this.buttonNext.removeEventListener("click",this.handleNext),document.removeEventListener("keydown",this.handleKeydownArrowRight),this.buttonPrev.removeEventListener("click",this.handlePrev),this.body.removeEventListener("keydown",this.handleKeydownArrowLeft),this.popup.removeEventListener("mousemove",this.handleMouseMovePopup),this.popup.removeEventListener("mouseleave",this.handleMoseLeavePopup),this.buttonStop.removeEventListener("click",this.handleStop),document.removeEventListener("click",this.handleOutclick)}},{key:"mouseLeavePopup",value:function(){this.isHidePopup&&this.isShowPopup&&-1===this.checkFinish&&(this.hidePopup("hide"),this.isShowPopup=!1)}},{key:"mouseMovePopup",value:function(){this.isHidePopup&&-1===this.checkFinish&&(this.hidePopup("show"),this.isShowPopup=!0)}},{key:"keydownArrowRight",value:function(t){"ArrowRight"===t.key&&this.next()}},{key:"keydownArrowLeft",value:function(t){"ArrowLeft"===t.key&&this.prev()}},{key:"next",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep<this.blocks.length-1&&(this.hidePopup("show"),this.isShowPopup=!0,this.stepProgressBar+=2,this.stepDescription+=1,this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.startAnimation(this.commonStep,"next"),this.commonStep++),this.commonStep===this.blocks.length-1&&stop(),this.updateTextButtons()}},{key:"prev",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep>0&&(this.hidePopup("show"),this.isShowPopup=!0,this.stepProgressBar-=2,this.stepDescription-=1,this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.startAnimation(this.commonStep,"prev"),this.commonStep--),this.updateTextButtons()}},{key:"start",value:function(){this.canvas.style.zIndex=this.config.zIndex,this.canvas.style.display="block",this.popup.style.visibility="visible",this.body.style.overflow="hidden",this.isStarted||(this.addEventListeners(),this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.updateTextButtons(),window.scroll(0,this.startPositionScroll),this.startAnimation(this.commonStep,"next"),this.isStarted=!0,this.commonStep++)}},{key:"stop",value:function(){-1===this.checkFinish&&this.isStarted&&(this.popup.style.top=this.defaultPopTop,this.popup.style.left=this.defaultPopLeft,this.popup.style.transitionDuration="",this.popup.style.visibility="hidden",this.isHidePopup=!1,this.canvas.style.zIndex=-1,this.canvas.style.display="none",this.body.style.overflow="visible",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isStarted=!1,this.commonStep=-1,this.stepProgressBar=0,this.stepDescription=0,this.removeEventListeners(),window.scroll(0,0))}},{key:"outclick",value:function(){!this.popup.contains(event.target)&&this.config.outclick&&this.stop()}},{key:"getCommonHeightdocument",value:function(){return Math.max(this.body.scrollHeight,this.body.offsetHeight,this.body.clientHeight,this.html.clientHeight,this.html.scrollHeight,this.html.offsetHeight)}},{key:"updateTextButtons",value:function(){this.commonStep===this.blocks.length-1?this.next.innerHTML="finish":this.next.innerHTML=this.defaultButtonNextText}},{key:"hidePopup",value:function(t){"hide"===t?(this.popup.style.transitionDuration="200ms",this.popup.style.opacity=.2):this.popup.style.opacity=1}},{key:"buildDefaultPopup",value:function(){var t=document.createElement("div");t.setAttribute("id","site-tutorial-control-panel");var e=document.createElement("div");e.setAttribute("id","description");var i=document.createElement("h");i.setAttribute("id","title-site-tutorial");var s=document.createElement("p");s.setAttribute("id","desctirption-site-tutorial");var o=document.createElement("span");o.setAttribute("id","stop-site-tutorial");var n=document.createElement("div");n.setAttribute("id","nav");var h=document.createElement("div");h.setAttribute("id","progress-wrap");var r=document.createElement("div");r.setAttribute("id","progress-site-tutorial");var a=document.createElement("p");a.setAttribute("id","progress-counter-site-tutorial");var l=document.createElement("div");l.setAttribute("id","group-buttons");var d=document.createElement("button");d.setAttribute("id","prev-site-tutorial"),d.innerHTML="back";var c=document.createElement("button");return c.setAttribute("id","next-site-tutorial"),c.innerHTML="next",t.appendChild(e),t.appendChild(n),e.appendChild(i),e.appendChild(s),e.appendChild(o),n.appendChild(h),n.appendChild(l),l.appendChild(d),l.appendChild(c),this.config.progressBar&&h.appendChild(r),this.config.progressBar.counter&&h.appendChild(a),t}},{key:"buildProgressBar",value:function(){this.progress=document.querySelector("#progress-site-tutorial"),this.progress.style.width="100%",this.progress.style.display="flex",this.progress.style.alignItems="center",this.progress.style.justifyContent="center";var t=document.createElement("div");t.setAttribute("id","one-step-site-tutorial");var e=document.createElement("div");e.setAttribute("id","line-site-tutorial");for(var i=0;i<this.blocks.length;i++){var s=t.cloneNode(!0),o=e.cloneNode(!0);o.style.width=100/this.blocks.length-1+"%",o.style.height="1px",o.style.backgroundColor=this.config.progressBar.color,s.style.border="solid 1px "+this.config.progressBar.color,s.style.minWidth="7px",s.style.minHeight="7px",s.style.borderRadius="50%",this.progress.appendChild(s),i!==this.blocks.length-1&&this.progress.appendChild(o)}this.config.progressBar.counter&&(this.progressCounter=document.getElementById("progress-counter-site-tutorial"),this.progressCounter.innerHTML="1/"+(this.blocks.length+1))}},{key:"updateProgress",value:function(){var t=this;this.progress.childNodes.forEach(function(e,i){(i%2==0&&(e.style.backgroundColor=""),i<=t.stepProgressBar&&i%2==0)&&(t.progress.childNodes[i].style.backgroundColor=t.config.progressBar.color);t.progressCounter&&(t.progressCounter.innerHTML=t.stepDescription+1+"/"+t.blocks.length)})}},{key:"updateDescription",value:function(){this.isHidePopup=!1,this.popup.style.transitionDuration="";var t=document.querySelector("#desctirption-site-tutorial"),e=document.querySelector("#title-site-tutorial"),i=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].title,s=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].text,o=this.blocks[this.stepDescription].attributes["tutorial-title"]&&this.blocks[this.stepDescription].attributes["tutorial-title"].value,n=this.blocks[this.stepDescription].attributes["tutorial-text"]&&this.blocks[this.stepDescription].attributes["tutorial-text"].value;e.innerHTML=i?this.config.steps[this.stepDescription].title:o||"",t.innerHTML=s?this.config.steps[this.stepDescription].text:n||""}},{key:"sortBlocks",value:function(){for(var t=document.querySelectorAll("[site-tutorial-step]"),e=[],i=0;i<t.length;i++)e.push(t[i]);return e.sort(function(t,e){return+t.attributes["site-tutorial-step"].value-+e.attributes["site-tutorial-step"].value})}},{key:"getCoords",value:function(t){var e=t.getBoundingClientRect();return{top:Math.round(e.top+scrollY),left:Math.round(e.left+scrollX)}}},{key:"getzIndex",value:function(){var t=this;this.blocks.forEach(function(e){t.defaultzIndexes.push(e.style.zIndex)})}},{key:"setDefaultzIndex",value:function(){var t=this;this.defaultzIndexes.forEach(function(e,i){t.blocks[i].style.zIndex=e})}},{key:"startAnimation",value:function(t,e){var i=this;this.buttonNext.disabled=!0,this.buttonPrev.disabled=!0,this.buttonStop.disabled=!0,this.setDefaultzIndex();var s=void 0,o=void 0;-1===t?(s=this.blocks[0],this.popup.style.top=this.blocks[0].offsetTop+this.blocks[0].offsetHeight+2*this.offset+"px"):s=this.blocks[t],"next"===e?o=1:"prev"===e&&(o=-1);var n=this.getCoords(s),h=s.offsetWidth,r=s.offsetHeight,a=n.top,l=n.left,d=this.blocks[t+o],c=this.getCoords(d),u=d.offsetWidth,p=d.offsetHeight,v=c.top,f=c.left;this.checkFinish=0;var m=0,g=0,y=!1,b=function(t,e){return(e-t)/i.time/i.frame_rate},k=function(t){i.canvas.height=i.getCommonHeightdocument();var e=i.ctx,s=i.canvas,o=i.padding,n=i.config;e.clearRect(0,0,s.width,s.height),e.fillStyle="rgba(0,0,0, "+(n.opacityBackground||.7)+")",e.fillRect(0,0,Math.max(0,t.divX-o),Math.max(0,s.height)),e.fillStyle="rgba(0,0,0, "+(n.opacityBackground||.7)+")",e.fillRect(Math.max(0,t.divX-o<0?0:t.divX-o),0,Math.max(0,s.width),Math.max(0,t.divY-o)),e.fillStyle="rgba(0,0,0, "+(n.opacityBackground||.7)+")",e.fillRect(Math.max(0,t.divX+t.divWidth+o),Math.max(0,t.divY-o),Math.max(0,s.width-t.divX-o),Math.max(0,s.height)),e.fillStyle="rgba(0,0,0, "+(n.opacityBackground||.7)+")",e.fillRect(Math.max(0,t.divX-o),Math.max(0,t.divY+t.divHeight+o),Math.max(0,t.divWidth+2*o),Math.max(0,s.height)),e.fillStyle="rgba(0,0,0,0)",e.fillRect(Math.max(0,t.divX-o),Math.max(0,t.divY-o),Math.max(0,t.divWidth+2*o),Math.max(0,t.divHeight+2*o)),x()},x=function(){var t=i.popup,e=i.padding,s=(i.commonHeightDocument,i.offset);g++;var o=t.offsetWidth,n=t.offsetHeight,h=window.innerWidth,r=window.innerHeight,a=t.style,l=t.offsetTop,d=t.offsetLeft,c=f-s+(u+2*e)/2-o/2,m=v+p+2*s,k=v-n-s,x=v+p+s+e+n,w=f-o-s-e,P=f+u+o+s+e,S=Math.max(0,Math.floor(v-window.innerHeight/2+p/2));function M(t,i,c,m){var M=v+p/2-n/2;x>this.getCommonHeightdocument()?m=v-n-s-e:k<v&&x>r+S&&P<h?(m=M,i=f+u+s+e):k<v&&x>r+S&&w<0?(m=M,i=f-o-e-w,this.isHidePopup=!0):k<v&&x>r+S&&(m=M,i=f-o-s-e),d+=b(t,i)*g,(l+=b(c,m)*g)===m&&d===i&&(g=0,y=!0),a.left=d+"px",a.top=l+"px"}(M=M.bind(i))(d,c-10<0?10:c+o>h?h-o-10:c,l,m)},w=function(){i.buttonPrev.disabled=!(0!==i.commonStep),i.buttonStop.disabled=!1,i.buttonNext.disabled=!1,i.checkFinish=-1},P=function(){var t,e,s=(m++,l+=b(l,f)*m,a+=b(a,v)*m,h+=b(h,u)*m,r+=b(r,p)*m,l===f&&a===v&&h===u&&r===p&&(i.checkFinish=4),(a+p/2>window.pageYOffset+window.innerHeight/2||a!==v)&&window.scroll(0,a-window.innerHeight/2+r/2),4===i.checkFinish&&y?(m=0,{divWidth:u,divHeight:p,divX:f,divY:v,finish:!0}):{divWidth:Math.round(h),divHeight:Math.round(r),divX:Math.round(l),divY:Math.round(a)});s.finish&&((t=new Promise(function(t){var e=i.config.steps[i.stepDescription]&&i.config.steps[i.stepDescription].callback;e?Promise.resolve(e(d)).then(function(){return t()}).catch(function(t){return console.error(t)}):t()}),e=new Promise(function(t){i.config.callback?Promise.resolve(i.config.callback(d,i.commonStep)).then(function(){return t()}).catch(function(t){return console.log(t)}):t()}),Promise.all([t,e])).then(function(){w()}).catch(function(){w()}),clearInterval(i.animate),i.isHidePopup&&i.hidePopup("hide")),k(s)};this.animate=setInterval(function(){i.commonStep>=0?P():(k({divWidth:h,divHeight:r,divX:l,divY:a}),clearInterval(i.animate),i.checkFinish=-1)},1/this.frame_rate)}}]),t}();