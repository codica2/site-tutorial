"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},s=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),s.forEach(function(e){_defineProperty(t,e,i[e])})}return t}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var SiteTutorial=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(_classCallCheck(this,t),"interactive"==document.readyState){this.config=_objectSpread({},{time:1e3,opacity:.7,zIndex:1e3,padding:10,outclick:!1,autoStart:!1,progressBar:null,steps:null,callback:null},e),this.blocks=this.sortBlocks(),this.body=document.body,this.html=document.documentElement,this.padding=this.config.padding>15?10:Math.max(0,this.config.padding),this.offset=10,this.time=this.config.time,this.frame_rate=.06,this.animate,this.commonStep=-1,this.checkFinish=-1,this.isStarted=!1,this.isHidePopup=!1,this._isShowPopup=!1,this.startPositionScroll=this.blocks[0].offsetTop-window.innerHeight/2,e.popup||this.body.appendChild(this.buildDefaultPopup()),this.popup=document.querySelector("#site-tutorial-control-panel"),this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","site-tutroial"),this.ctx=this.canvas.getContext("2d"),this.commonHeightDocument=this.getCommonHeightdocument(),this.defaultzIndexes=[],this.next=this.next.bind(this),this.prev=this.prev.bind(this),this.keydownArrowRight=this.keydownArrowRight.bind(this),this.keydownArrowLeft=this.keydownArrowLeft.bind(this),this.mouseMovePopup=this.mouseMovePopup.bind(this),this.mouseLeavePopup=this.mouseLeavePopup.bind(this),this.outclick=this.outclick.bind(this),this.handleStop=this.stop.bind(this),this.start=this.start.bind(this),this.initialize()}}return _createClass(t,[{key:"initialize",value:function(){var t=this.canvas,e=this.popup,i=this.body,s=this.config;t.width=window.innerWidth+1,t.height=this.commonHeightDocument,t.style.position="absolute",t.style.zIndex=s.zIndex,t.style.top="0px",t.style.left="0px",t.style.display="none",i.appendChild(t),e.style.position="absolute",e.style.visibility="hidden",this.defaultPopLeft=-this.popup.offsetWidth+"px",e.style.left=this.defaultPopLeft,e.style.zIndex=this.canvas.style.zIndex+1,this.buttonPrev=document.querySelector("#prev-site-tutorial"),this.buttonStart=document.querySelector("#start-site-tutorial"),this.buttonNext=document.querySelector("#next-site-tutorial"),this.buttonStop=document.querySelector("#stop-site-tutorial"),this.defaultButtonNextText=this.next.innerHTML,this.stepDescription=0,s.progressBar&&(this.stepProgressBar=0,this.buildProgressBar()),this.getzIndex(),this.config.autoStart&&this.start(),this.buttonStart.addEventListener("click",this.start)}},{key:"addEventListeners",value:function(){this.buttonNext.addEventListener("click",this.next),document.addEventListener("keydown",this.keydownArrowRight),this.buttonPrev.addEventListener("click",this.prev),this.body.addEventListener("keydown",this.keydownArrowLeft),this.popup.addEventListener("mousemove",this.mouseMovePopup),this.popup.addEventListener("mouseleave",this.mouseLeavePopup),this.buttonStop.addEventListener("click",this.handleStop),document.addEventListener("click",this.outclick)}},{key:"removeEventListeners",value:function(){this.buttonNext.removeEventListener("click",this.next),document.removeEventListener("keydown",this.keydownArrowRight),this.buttonPrev.removeEventListener("click",this.prev),this.body.removeEventListener("keydown",this.keydownArrowLeft),this.popup.removeEventListener("mousemove",this.mouseMovePopup),this.popup.removeEventListener("mouseleave",this.mouseLeavePopup),this.buttonStop.removeEventListener("click",this.handleStop),document.removeEventListener("click",this.outclick)}},{key:"mouseLeavePopup",value:function(){this.isHidePopup&&this._isShowPopup&&-1===this.checkFinish&&(this.hidePopup("hide"),this.isShowPopup=!1)}},{key:"mouseMovePopup",value:function(){this.isHidePopup&&-1===this.checkFinish&&(this.hidePopup("show"),this.isShowPopup=!0)}},{key:"keydownArrowRight",value:function(t){"ArrowRight"===t.key&&this.next()}},{key:"keydownArrowLeft",value:function(t){"ArrowLeft"===t.key&&this.prev()}},{key:"next",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep<this.blocks.length-1&&(this.hidePopup("show"),this.isShowPopup=!0,this.stepProgressBar+=2,this.stepDescription+=1,this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.startAnimation(this.commonStep,"next"),this.commonStep++),this.commonStep===this.blocks.length-1&&stop(),this.updateTextButtons()}},{key:"prev",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep>0&&(this.hidePopup("show"),this.isShowPopup=!0,this.stepProgressBar-=2,this.stepDescription-=1,this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.startAnimation(this.commonStep,"prev"),this.commonStep--),this.updateTextButtons()}},{key:"start",value:function(){this.canvas.style.zIndex=this.config.zIndex,this.canvas.style.display="block",this.popup.style.visibility="visible",this.body.style.overflow="hidden",this.isStarted||(this.addEventListeners(),this.config.progressBar&&this.updateProgress(),this.updateDescription(),this.updateTextButtons(),window.scroll(0,this.startPositionScroll),this.startAnimation(this.commonStep,"next"),this.isStarted=!0,this.commonStep++)}},{key:"stop",value:function(){-1===this.checkFinish&&this.isStarted&&(this.popup.style.top=this.defaultPopTop,this.popup.style.left=this.defaultPopLeft,this.popup.style.transitionDuration="",this.popup.style.visibility="hidden",this.isHidePopup=!1,this.canvas.style.zIndex=-1,this.canvas.style.display="none",this.body.style.overflow="visible",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isStarted=!1,this.commonStep=-1,this.stepProgressBar=0,this.stepDescription=0,this.removeEventListeners(),window.scroll(0,0))}},{key:"outclick",value:function(){!this.popup.contains(event.target)&&this.config.outclick&&this.stop()}},{key:"getCommonHeightdocument",value:function(){return Math.max(this.body.scrollHeight,this.body.offsetHeight,this.body.clientHeight,this.html.clientHeight,this.html.offsetHeight)}},{key:"updateTextButtons",value:function(){this.commonStep===this.blocks.length-1?this.next.innerHTML="finish":this.next.innerHTML=this.defaultButtonNextText}},{key:"hidePopup",value:function(t){"hide"===t?(this.popup.style.transitionDuration="200ms",this.popup.style.opacity=.2):this.popup.style.opacity=1}},{key:"buildDefaultPopup",value:function(){var t=document.createElement("div");t.setAttribute("id","site-tutorial-control-panel");var e=document.createElement("div");e.setAttribute("id","description");var i=document.createElement("h");i.setAttribute("id","title-site-tutorial");var s=document.createElement("p");s.setAttribute("id","desctirption-site-tutorial");var o=document.createElement("span");o.setAttribute("id","stop-site-tutorial");var n=document.createElement("div");n.setAttribute("id","nav");var r=document.createElement("div");r.setAttribute("id","progress-wrap");var h=document.createElement("div");h.setAttribute("id","group-buttons");var a=document.createElement("button");a.setAttribute("id","prev-site-tutorial"),a.innerHTML="back";var c=document.createElement("button");if(c.setAttribute("id","next-site-tutorial"),c.innerHTML="next",t.appendChild(e),t.appendChild(n),e.appendChild(i),e.appendChild(s),e.appendChild(o),n.appendChild(r),n.appendChild(h),h.appendChild(a),h.appendChild(c),this.config.progressBar){var l=document.createElement("div");l.setAttribute("id","progress-site-tutorial"),r.appendChild(l)}if(this.config.progressBar.counter){var p=document.createElement("p");p.setAttribute("id","progress-counter-site-tutorial"),r.appendChild(p)}return t}},{key:"buildProgressBar",value:function(){this.progress=document.querySelector("#progress-site-tutorial"),this.progress.style.width="100%",this.progress.style.display="flex",this.progress.style.alignItems="center",this.progress.style.justifyContent="center";var t=document.createElement("div");t.setAttribute("id","one-step-site-tutorial");var e=document.createElement("div");e.setAttribute("id","line-site-tutorial");for(var i=0;i<this.blocks.length;i++){var s=t.cloneNode(!0),o=e.cloneNode(!0);o.style.width=100/this.blocks.length-1+"%",o.style.height="1px",o.style.backgroundColor=this.config.progressBar.color,s.style.border="solid 1px "+this.config.progressBar.color,s.style.minWidth="7px",s.style.minHeight="7px",s.style.borderRadius="50%",this.progress.appendChild(s),i!==this.blocks.length-1&&this.progress.appendChild(o)}this.config.progressBar.counter&&(this.progressCounter=document.getElementById("progress-counter-site-tutorial"),this.progressCounter.innerHTML="1/"+(this.blocks.length+1))}},{key:"updateProgress",value:function(){var t=this;this.progress.childNodes.forEach(function(e,i){(i%2==0&&(e.style.backgroundColor=""),i<=t.stepProgressBar&&i%2==0)&&(t.progress.childNodes[i].style.backgroundColor=t.config.progressBar.color);t.progressCounter&&(t.progressCounter.innerHTML=t.stepDescription+1+"/"+t.blocks.length)})}},{key:"updateDescription",value:function(){this.isHidePopup=!1,this.popup.style.transitionDuration="";var t=document.querySelector("#desctirption-site-tutorial"),e=document.querySelector("#title-site-tutorial"),i=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].title,s=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].text,o=this.blocks[this.stepDescription].attributes["tutorial-title"]&&this.blocks[this.stepDescription].attributes["tutorial-title"].value,n=this.blocks[this.stepDescription].attributes["tutorial-text"]&&this.blocks[this.stepDescription].attributes["tutorial-text"].value;e.innerHTML=i?this.config.steps[this.stepDescription].title:o||"",t.innerHTML=s?this.config.steps[this.stepDescription].text:n||""}},{key:"sortBlocks",value:function(){for(var t=document.querySelectorAll("[site-tutorial-step]"),e=[],i=0;i<t.length;i++)e.push(t[i]);return e.sort(function(t,e){return+t.attributes["site-tutorial-step"].value-+e.attributes["site-tutorial-step"].value})}},{key:"getCoords",value:function(t){var e=t.getBoundingClientRect();return{top:Math.round(e.top+scrollY),left:Math.round(e.left+scrollX)}}},{key:"getzIndex",value:function(){var t=this;this.blocks.forEach(function(e){t.defaultzIndexes.push(e.style.zIndex)})}},{key:"setDefaultzIndex",value:function(){var t=this;this.defaultzIndexes.forEach(function(e,i){t.blocks[i].style.zIndex=e})}},{key:"startAnimation",value:function(t,e){var i,s,o=this;this.buttonNext.disabled=!0,this.buttonPrev.disabled=!0,this.buttonStop.disabled=!0,this.setDefaultzIndex(),-1===t?(i=this.blocks[0],this.popup.style.top=this.blocks[0].offsetTop+this.blocks[0].offsetHeight+2*this.offset+"px"):i=this.blocks[t],"next"===e?s=1:"prev"===e&&(s=-1);var n=this.getCoords(i),r=i.offsetWidth,h=i.offsetHeight,a=n.top,c=n.left,l=this.blocks[t+s],p=this.getCoords(l),u=l.offsetWidth,d=l.offsetHeight,f=p.top,v=p.left;this.checkFinish=0;var m=0,g=0,y=!1,b=function(t,e){return(e-t)/o.time/o.frame_rate},k=function(t){var e=o.ctx,i=o.canvas,s=o.padding,n=o.config;i.height=o.getCommonHeightdocument(),e.clearRect(0,0,i.width,i.height),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(0,0,Math.max(0,t.divX-s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX-s<0?0:t.divX-s),0,Math.max(0,i.width),Math.max(0,t.divY-s)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX+t.divWidth+s),Math.max(0,t.divY-s),Math.max(0,i.width-t.divX-s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX-s),Math.max(0,t.divY+t.divHeight+s),Math.max(0,t.divWidth+2*s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0,0)",e.fillRect(Math.max(0,t.divX-s),Math.max(0,t.divY-s),Math.max(0,t.divWidth+2*s),Math.max(0,t.divHeight+2*s)),x()},x=function(){var t=o.popup,e=o.padding,i=o.offset;g++;var s=t.offsetWidth,n=t.offsetHeight,r=window.innerWidth,h=window.innerHeight,a=t.style,c=t.offsetTop,l=t.offsetLeft,p=v-i+(u+2*e)/2-s/2,m=f+d+2*i,k=f-n-i,x=f+d+i+e+n,w=v-s-i-e,P=v+u+s+i+e,S=Math.max(0,Math.floor(f-window.innerHeight/2+d/2));function L(t,o,p,m){var L=f+d/2-n/2;x>this.getCommonHeightdocument()?m=f-n-i-e:k<f&&x>h+S&&P<r?(m=L,o=v+u+i+e):k<f&&x>h+S&&w<0?(m=L,o=v-s-e-w,this.isHidePopup=!0):k<f&&x>h+S&&(m=L,o=v-s-i-e),l+=b(t,o)*g,(c+=b(p,m)*g)===m&&l===o&&(g=0,y=!0),a.left=l+"px",a.top=c+"px"}(L=L.bind(o))(l,p-10<0?10:p+s>r?r-s-10:p,c,m)},w=function(){var t,e,i=(m++,c+=b(c,v)*m,a+=b(a,f)*m,r+=b(r,u)*m,h+=b(h,d)*m,c===v&&a===f&&r===u&&h===d&&(o.checkFinish=4),(a+d/2>window.pageYOffset+window.innerHeight/2||a!==f)&&window.scroll(0,a-window.innerHeight/2+h/2),4===o.checkFinish&&y?(m=0,{divWidth:u,divHeight:d,divX:v,divY:f,isFinish:!0}):{divWidth:Math.round(r),divHeight:Math.round(h),divX:Math.round(c),divY:Math.round(a)});i.isFinish&&((t=new Promise(function(t){var e=o.config.steps[o.stepDescription]&&o.config.steps[o.stepDescription].callback;e?Promise.resolve(e(l)).then(function(){return t()}).catch(function(t){return console.error(t)}):t()}),e=new Promise(function(t){o.config.callback?Promise.resolve(o.config.callback(l,o.commonStep)).then(function(){return t()}).catch(function(t){return console.error(t)}):t()}),Promise.all([t,e])).finally(function(){return o.buttonPrev.disabled=!(0!==o.commonStep),o.buttonStop.disabled=!1,o.buttonNext.disabled=!1,void(o.checkFinish=-1)}),clearInterval(o.animate),o.isHidePopup&&o.hidePopup("hide")),k(i)};this.animate=setInterval(function(){o.commonStep>=0?w():(k({divWidth:r,divHeight:h,divX:c,divY:a}),clearInterval(o.animate),o.checkFinish=-1)},1/this.frame_rate)}},{key:"isShowPopup",set:function(t){this._isShowPopup=t}}]),t}();