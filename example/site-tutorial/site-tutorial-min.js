"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},s=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),s.forEach(function(e){_defineProperty(t,e,i[e])})}return t}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var _addEventListeners=Symbol("addEventListeners"),_removeEventListeners=Symbol("removeEventListeners"),_mouseLeavePopup=Symbol("mouseLeavePopup"),_mouseMovePopup=Symbol("mouseMovePopup"),_keydownArrowRight=Symbol("keydownArrowRight"),_keydownArrowLeft=Symbol("keydownArrowLeft"),_outclick=Symbol("outclick"),_getCommonHeightdocument=Symbol("getCommonHeightdocument"),_updateTextButtons=Symbol("updateTextButtons"),_hidePopup=Symbol("hidePopup"),_buildDefaultPopup=Symbol("buildDefaultPopup"),_buildProgressBar=Symbol("buildProgressBar"),_updateProgress=Symbol("updateProgress"),_updateDescription=Symbol("updateDescription"),_sortBlocks=Symbol("sortBlocks"),_getCoords=Symbol("getCoords"),_getzIndex=Symbol("getzIndex"),_setDefaultzIndex=Symbol("setDefaultzIndex"),_startAnimation=Symbol("startAnimation"),SiteTutorial=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t);this.body=document.body,this.html=document.documentElement,this.config=_objectSpread({},{time:1e3,opacity:.7,zIndex:1e3,padding:10,outclick:!1,autoStart:!1,progressBar:null,steps:null,callback:null},e),this.blocks=this[_sortBlocks](),this.padding=this.config.padding,this.offset=10,this.time=this.config.time,this.frame_rate=.06,this.animate,this.commonStep=-1,this.checkFinish=-1,this.isStarted=!1,this.isHidePopup=!1,this._isShowPopup=!1,this.startPositionScroll=this.blocks[0].offsetTop-window.innerHeight/2,e.popup||this.body.appendChild(this[_buildDefaultPopup]()),this.popup=document.querySelector("#site-tutorial-control-panel"),this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","site-tutroial"),this.ctx=this.canvas.getContext("2d"),this.commonHeightDocument=this[_getCommonHeightdocument](),this.next=this.next.bind(this),this.prev=this.prev.bind(this),this.stop=this.stop.bind(this),this.start=this.start.bind(this),this[_keydownArrowRight]=this[_keydownArrowRight].bind(this),this[_keydownArrowLeft]=this[_keydownArrowLeft].bind(this),this[_mouseMovePopup]=this[_mouseMovePopup].bind(this),this[_mouseLeavePopup]=this[_mouseLeavePopup].bind(this),this[_outclick]=this[_outclick].bind(this),this.popup.style.position="absolute",this.popup.style.visibility="hidden",this.config.autoStart&&this.initialize()}return _createClass(t,[{key:"initialize",value:function(){var t=this.canvas,e=this.popup,i=this.body,s=this.config;t.width=window.innerWidth+1,t.height=this.commonHeightDocument,t.style.position="absolute",t.style.zIndex=s.zIndex,t.style.top="0px",t.style.left="0px",t.style.display="none",i.appendChild(t),this.defaultPopLeft=-this.popup.offsetWidth+"px",e.style.left=this.defaultPopLeft,e.style.zIndex=this.canvas.style.zIndex+1,this.buttonPrev=document.querySelector("#prev-site-tutorial"),this.buttonNext=document.querySelector("#next-site-tutorial"),this.buttonStop=document.querySelector("#stop-site-tutorial"),this.defaultButtonNextText=this.buttonNext.innerHTML,this.stepDescription=0,s.progressBar&&(this.stepProgressBar=0,this[_buildProgressBar]()),this[_getzIndex](),this.start()}},{key:_addEventListeners,value:function(){this.buttonNext.addEventListener("click",this.next),document.addEventListener("keydown",this[_keydownArrowRight]),this.buttonPrev.addEventListener("click",this.prev),this.body.addEventListener("keydown",this[_keydownArrowLeft]),this.popup.addEventListener("mousemove",this[_mouseMovePopup]),this.popup.addEventListener("mouseleave",this[_mouseLeavePopup]),this.buttonStop.addEventListener("click",this.stop),document.addEventListener("click",this[_outclick])}},{key:_removeEventListeners,value:function(){this.buttonNext.removeEventListener("click",this.next),document.removeEventListener("keydown",this[_keydownArrowRight]),this.buttonPrev.removeEventListener("click",this.prev),this.body.removeEventListener("keydown",this[_keydownArrowLeft]),this.popup.removeEventListener("mousemove",this[_mouseMovePopup]),this.popup.removeEventListener("mouseleave",this[_mouseLeavePopup]),this.buttonStop.removeEventListener("click",this.stop),document.removeEventListener("click",this[_outclick])}},{key:_mouseLeavePopup,value:function(){this.isHidePopup&&this._isShowPopup&&-1===this.checkFinish&&(this[_hidePopup]("hide"),this.isShowPopup=!1)}},{key:_mouseMovePopup,value:function(){this.isHidePopup&&-1===this.checkFinish&&(this[_hidePopup]("show"),this.isShowPopup=!0)}},{key:_keydownArrowRight,value:function(t){"ArrowRight"===t.key&&this.next()}},{key:_keydownArrowLeft,value:function(t){"ArrowLeft"===t.key&&this.prev()}},{key:"next",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep<this.blocks.length-1&&(this[_hidePopup]("show"),this.isShowPopup=!0,this.stepProgressBar+=2,this.stepDescription+=1,this.config.progressBar&&this[_updateProgress](),this[_updateDescription](),this[_startAnimation](this.commonStep,"next"),this.commonStep++),this.commonStep===this.blocks.length-1&&this.stop(),this[_updateTextButtons]()}},{key:"prev",value:function(){-1===this.checkFinish&&this.isStarted&&this.commonStep>0&&(this[_hidePopup]("show"),this.isShowPopup=!0,this.stepProgressBar-=2,this.stepDescription-=1,this.config.progressBar&&this[_updateProgress](),this[_updateDescription](),this[_startAnimation](this.commonStep,"prev"),this.commonStep--),this[_updateTextButtons]()}},{key:"start",value:function(){this.canvas.style.zIndex=this.config.zIndex,this.canvas.style.display="block",this.popup.style.visibility="visible",this.body.style.overflow="hidden",this.isStarted||(this[_addEventListeners](),this.config.progressBar&&this[_updateProgress](),this[_updateDescription](),this[_updateTextButtons](),window.scroll(0,this.startPositionScroll),this[_startAnimation](this.commonStep,"next"),this.isStarted=!0,this.commonStep++)}},{key:"stop",value:function(){-1===this.checkFinish&&this.isStarted&&(this.popup.style.top=this.defaultPopTop,this.popup.style.left=this.defaultPopLeft,this.popup.style.transitionDuration="",this.popup.style.visibility="hidden",this.isHidePopup=!1,this.canvas.style.zIndex=-1,this.canvas.style.display="none",this.body.style.overflow="visible",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isStarted=!1,this.commonStep=-1,this.stepProgressBar=0,this.stepDescription=0,this[_removeEventListeners](),window.scroll(0,0))}},{key:_outclick,value:function(t){!this.popup.contains(t.target)&&this.config.outclick&&this.stop()}},{key:_getCommonHeightdocument,value:function(){return Math.max(this.body.scrollHeight,this.body.offsetHeight,this.body.clientHeight,this.html.clientHeight,this.html.offsetHeight)}},{key:_updateTextButtons,value:function(){this.commonStep===this.blocks.length-1?this.buttonNext.innerHTML="finish":this.buttonNext.innerHTML=this.defaultButtonNextText}},{key:_hidePopup,value:function(t){"hide"===t?(this.popup.style.transitionDuration="200ms",this.popup.style.opacity=.2):this.popup.style.opacity=1}},{key:_buildDefaultPopup,value:function(){var t=document.createElement("div");t.setAttribute("id","site-tutorial-control-panel");var e=document.createElement("div");e.setAttribute("id","description");var i=document.createElement("h");i.setAttribute("id","title-site-tutorial");var s=document.createElement("p");s.setAttribute("id","desctirption-site-tutorial");var o=document.createElement("span");o.setAttribute("id","stop-site-tutorial");var n=document.createElement("div");n.setAttribute("id","nav");var r=document.createElement("div");r.setAttribute("id","progress-wrap");var h=document.createElement("div");h.setAttribute("id","group-buttons");var a=document.createElement("button");a.setAttribute("id","prev-site-tutorial"),a.innerHTML="back";var p=document.createElement("button");if(p.setAttribute("id","next-site-tutorial"),p.innerHTML="next",t.appendChild(e),t.appendChild(n),e.appendChild(i),e.appendChild(s),e.appendChild(o),n.appendChild(r),n.appendChild(h),h.appendChild(a),h.appendChild(p),this.config.progressBar){var u=document.createElement("div");u.setAttribute("id","progress-site-tutorial"),r.appendChild(u)}if(this.config.progressBar&&this.config.progressBar.counter){var l=document.createElement("p");l.setAttribute("id","progress-counter-site-tutorial"),r.appendChild(l)}return t}},{key:_buildProgressBar,value:function(){this.progress=document.querySelector("#progress-site-tutorial"),this.progress.style.width="100%",this.progress.style.display="flex",this.progress.style.alignItems="center",this.progress.style.justifyContent="center";var t=document.createElement("div");t.setAttribute("id","one-step-site-tutorial");var e=document.createElement("div");e.setAttribute("id","line-site-tutorial");for(var i=0;i<this.blocks.length;i++){var s=t.cloneNode(!0),o=e.cloneNode(!0);o.style.width=100/this.blocks.length-1+"%",o.style.height="1px",o.style.backgroundColor=this.config.progressBar.color,s.style.border="solid 1px "+this.config.progressBar.color,s.style.minWidth="7px",s.style.minHeight="7px",s.style.borderRadius="50%",this.progress.appendChild(s),i!==this.blocks.length-1&&this.progress.appendChild(o)}this.config.progressBar.counter&&(this.progressCounter=document.getElementById("progress-counter-site-tutorial"),this.progressCounter.innerHTML="1/"+(this.blocks.length+1))}},{key:_updateProgress,value:function(){var t=this;this.progress.childNodes.forEach(function(e,i){(i%2==0&&(e.style.backgroundColor=""),i<=t.stepProgressBar&&i%2==0)&&(t.progress.childNodes[i].style.backgroundColor=t.config.progressBar.color);t.progressCounter&&(t.progressCounter.innerHTML=t.stepDescription+1+"/"+t.blocks.length)})}},{key:_updateDescription,value:function(){this.isHidePopup=!1,this.popup.style.transitionDuration="";var t=document.querySelector("#desctirption-site-tutorial"),e=document.querySelector("#title-site-tutorial"),i=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].title,s=this.config.steps&&this.config.steps[this.stepDescription]&&this.config.steps[this.stepDescription].text,o=this.blocks[this.stepDescription].attributes["tutorial-title"]&&this.blocks[this.stepDescription].attributes["tutorial-title"].value,n=this.blocks[this.stepDescription].attributes["tutorial-text"]&&this.blocks[this.stepDescription].attributes["tutorial-text"].value;e.innerHTML=i?this.config.steps[this.stepDescription].title:o||"",t.innerHTML=s?this.config.steps[this.stepDescription].text:n||""}},{key:_sortBlocks,value:function(){for(var t=document.querySelectorAll("[site-tutorial-step]"),e=[],i=0;i<t.length;i++)e.push(t[i]);return e.sort(function(t,e){return+t.attributes["site-tutorial-step"].value-+e.attributes["site-tutorial-step"].value})}},{key:_getCoords,value:function(t){var e=t.getBoundingClientRect();return{top:Math.round(e.top+window.scrollY),left:Math.round(e.left+window.scrollX)}}},{key:_getzIndex,value:function(){var t=this;this.defaultzIndexes=[],this.blocks.forEach(function(e){t.defaultzIndexes.push(e.style.zIndex)})}},{key:_setDefaultzIndex,value:function(){var t=this;this.defaultzIndexes.forEach(function(e,i){t.blocks[i].style.zIndex=e})}},{key:_startAnimation,value:function(t,e){var i,s,o=this;this.buttonNext.disabled=!0,this.buttonPrev.disabled=!0,this.buttonStop.disabled=!0,this[_setDefaultzIndex](),-1===t?(i=this.blocks[0],this.popup.style.top=this.blocks[0].offsetTop+this.blocks[0].offsetHeight+2*this.offset+"px"):i=this.blocks[t],"next"===e?s=1:"prev"===e&&(s=-1);var n=this[_getCoords](i),r=i.offsetWidth,h=i.offsetHeight,a=n.top,p=n.left,u=this.blocks[t+s],l=this[_getCoords](u),c=u.offsetWidth,d=u.offsetHeight,m=l.top,f=l.left;this.checkFinish=0;var v=0,g=0,y=!1,b=function(t,e){return(e-t)/o.time/o.frame_rate},k=function(t){var e=o.ctx,i=o.canvas,s=o.padding,n=o.config;i.height=o[_getCommonHeightdocument](),e.clearRect(0,0,i.width,i.height),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(0,0,Math.max(0,t.divX-s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX-s<0?0:t.divX-s),0,Math.max(0,i.width),Math.max(0,t.divY-s)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX+t.divWidth+s),Math.max(0,t.divY-s),Math.max(0,i.width-t.divX-s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0, ".concat(n.opacity||.7,")"),e.fillRect(Math.max(0,t.divX-s),Math.max(0,t.divY+t.divHeight+s),Math.max(0,t.divWidth+2*s),Math.max(0,i.height)),e.fillStyle="rgba(0,0,0,0)",e.fillRect(Math.max(0,t.divX-s),Math.max(0,t.divY-s),Math.max(0,t.divWidth+2*s),Math.max(0,t.divHeight+2*s)),_()},_=function(){var t=o.popup,e=o.padding,i=o.offset;g++;var s=t.offsetWidth,n=t.offsetHeight,r=window.innerWidth,h=window.innerHeight,a=t.style,p=t.offsetTop,u=t.offsetLeft,l=f-i+(c+2*e)/2-s/2,v=m+d+2*i,k=m-n-i,_=m+d+i+e+n,w=f-s-i-e,x=f+c+s+i+e,P=Math.max(0,Math.floor(m-window.innerHeight/2+d/2));function S(t,o,l,v){var S=m+d/2-n/2;_>this[_getCommonHeightdocument]()?v=m-n-i-e:k<m&&_>h+P&&x<r?(v=S,o=f+c+i+e):k<m&&_>h+P&&w<0?(v=S,o=f-s-e-w,this.isHidePopup=!0):k<m&&_>h+P&&(v=S,o=f-s-i-e),u+=b(t,o)*g,(p+=b(l,v)*g)===v&&u===o&&(g=0,y=!0),a.left=u+"px",a.top=p+"px"}(S=S.bind(o))(u,l-10<0?10:l+s>r?r-s-10:l,p,v)},w=function(){var t,e,i=(v++,p+=b(p,f)*v,a+=b(a,m)*v,r+=b(r,c)*v,h+=b(h,d)*v,p===f&&a===m&&r===c&&h===d&&(o.checkFinish=4),(a+d/2>window.pageYOffset+window.innerHeight/2||a!==m)&&window.scroll(0,a-window.innerHeight/2+h/2),4===o.checkFinish&&y?(v=0,{divWidth:c,divHeight:d,divX:f,divY:m,isFinish:!0}):{divWidth:Math.round(r),divHeight:Math.round(h),divX:Math.round(p),divY:Math.round(a)});i.isFinish&&((t=new Promise(function(t){var e=o.config.steps&&o.config.steps[o.stepDescription]&&o.config.steps[o.stepDescription].callback;e?Promise.resolve(e(u)).then(function(){return t()}).catch(function(t){return console.error(t)}):t()}),e=new Promise(function(t){o.config.callback?Promise.resolve(o.config.callback(u,o.commonStep)).then(function(){return t()}).catch(function(t){return console.error(t)}):t()}),Promise.all([t,e])).finally(function(){return o.buttonPrev.disabled=!(0!==o.commonStep),o.buttonStop.disabled=!1,o.buttonNext.disabled=!1,void(o.checkFinish=-1)}),clearInterval(o.animate),o.isHidePopup&&o[_hidePopup]("hide")),k(i)};this.animate=setInterval(function(){o.commonStep>=0?w():(k({divWidth:r,divHeight:h,divX:p,divY:a}),clearInterval(o.animate),o.checkFinish=-1)},1/this.frame_rate)}},{key:"isShowPopup",set:function(t){this._isShowPopup=t}},{key:"_padding",set:function(t){(this.padding>15||this.padding<0)&&(this.padding=10)}}]),t}();